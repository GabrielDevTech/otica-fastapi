# üìã Especifica√ß√£o de Endpoints - Service Orders (Hub de Vendas)

Este documento descreve todos os endpoints que precisam ser implementados no backend FastAPI para o m√≥dulo de **Service Orders (Ordens de Servi√ßo)**.

---

## üéØ Contexto

O m√≥dulo de Service Orders √© o cora√ß√£o do Hub de Vendas, permitindo criar e gerenciar Ordens de Servi√ßo (OS) que cont√™m Arma√ß√µes e Lentes. √â o primeiro passo do ciclo de venda.

---

## üìä Tabelas do Banco de Dados

As seguintes tabelas j√° existem no Supabase e devem ser utilizadas:

- `service_orders` - Ordens de servi√ßo principais
- `service_order_items` - Itens da OS (Arma√ß√£o ou Lente)
- `customers` - Clientes (j√° existe)
- `products_frames` - Arma√ß√µes (j√° existe)
- `products_lenses` - Lentes (j√° existe)
- `inventory_levels` - N√≠veis de estoque (j√° existe)
- `lens_stock_grid` - Grade de estoque de lentes (j√° existe)

---

## üîê Autentica√ß√£o e Autoriza√ß√£o

Todos os endpoints requerem:
- **Autentica√ß√£o:** JWT token no header `Authorization: Bearer {token}`
- **Multi-tenancy:** Filtro autom√°tico por `organization_id` (extra√≠do do token)
- **RBAC:** Valida√ß√£o de role conforme necess√°rio

**Roles permitidas:**
- `SELLER` - Criar e editar suas pr√≥prias OS
- `MANAGER` - Criar, editar e aprovar descontos
- `ADMIN` - Acesso total

---

## üìù Endpoints

### 1. Listar Service Orders

**GET** `/api/v1/service-orders`

Lista todas as Service Orders da organiza√ß√£o, com filtros opcionais.

**Query Parameters:**
```typescript
{
  status?: "DRAFT" | "PENDING" | "PAID" | "AWAITING_LENS" | "IN_PRODUCTION" | "READY" | "DELIVERED" | "CANCELLED";
  customer_id?: number;
  store_id?: number;
  seller_id?: number;
  q?: string; // Busca por n√∫mero da OS ou nome do cliente
  page?: number;
  limit?: number;
}
```

**Response 200:**
```json
{
  "items": [
    {
      "id": 1,
      "order_number": "OS-2024-001",
      "customer_id": 5,
      "customer_name": "Jo√£o Silva",
      "customer_cpf": "123.456.789-00",
      "store_id": 2,
      "store_name": "Loja Centro",
      "seller_id": 3,
      "seller_name": "Maria Santos",
      "status": "DRAFT",
      "subtotal": "850.00",
      "discount_amount": "50.00",
      "discount_percentage": "5.88",
      "total": "800.00",
      "max_discount_allowed": "100.00",
      "discount_approved_by": null,
      "created_at": "2024-12-15T10:30:00Z",
      "paid_at": null,
      "delivered_at": null,
      "notes": "Cliente preferiu arma√ß√£o preta",
      "items_count": 2
    }
  ],
  "total": 1,
  "page": 1,
  "limit": 20,
  "pages": 1
}
```

**Regras de Neg√≥cio:**
- Seller s√≥ v√™ suas pr√≥prias OS
- Manager/Admin v√™ todas as OS da loja/organiza√ß√£o
- Ordenar por `created_at DESC` (mais recentes primeiro)

---

### 2. Obter Service Order por ID

**GET** `/api/v1/service-orders/{id}`

Retorna os detalhes completos de uma Service Order, incluindo todos os itens.

**Response 200:**
```json
{
  "id": 1,
  "order_number": "OS-2024-001",
  "customer_id": 5,
  "customer": {
    "id": 5,
    "full_name": "Jo√£o Silva",
    "cpf": "123.456.789-00",
    "phone": "(11) 98765-4321",
    "email": "joao@email.com"
  },
  "store_id": 2,
  "store": {
    "id": 2,
    "name": "Loja Centro"
  },
  "seller_id": 3,
  "seller": {
    "id": 3,
    "full_name": "Maria Santos",
    "email": "maria@email.com"
  },
  "status": "DRAFT",
  "subtotal": "850.00",
  "discount_amount": "50.00",
  "discount_percentage": "5.88",
  "total": "800.00",
  "max_discount_allowed": "100.00",
  "discount_approved_by": null,
  "created_at": "2024-12-15T10:30:00Z",
  "paid_at": null,
  "delivered_at": null,
  "notes": "Cliente preferiu arma√ß√£o preta",
  "items": [
    {
      "id": 1,
      "item_type": "FRAME",
      "product_frame_id": 10,
      "product_lens_id": null,
      "product_name": "Arma√ß√£o Ray-Ban RB3025",
      "product_reference_code": "RB3025-PRE",
      "quantity": 1,
      "unit_price": "450.00",
      "discount_amount": "0.00",
      "total_price": "450.00",
      "reserved_quantity": 1,
      "reserved_at": "2024-12-15T10:30:00Z"
    },
    {
      "id": 2,
      "item_type": "LENS",
      "product_frame_id": null,
      "product_lens_id": 15,
      "product_name": "Lente Transitions Signature",
      "quantity": 1,
      "unit_price": "400.00",
      "discount_amount": "50.00",
      "total_price": "350.00",
      "lens_spherical": -2.50,
      "lens_cylindrical": -0.75,
      "lens_axis": 180,
      "lens_addition": null,
      "lens_side": "BOTH",
      "needs_purchasing": false,
      "reserved_quantity": 0,
      "reserved_at": null
    }
  ]
}
```

**Regras de Neg√≥cio:**
- Seller s√≥ pode ver suas pr√≥prias OS
- Manager/Admin podem ver todas

**Erros:**
- `404` - Service Order n√£o encontrada ou sem permiss√£o

---

### 3. Criar Service Order

**POST** `/api/v1/service-orders`

Cria uma nova Service Order no status `DRAFT`.

**Request Body:**
```json
{
  "customer_id": 5,
  "store_id": 2,
  "notes": "Cliente preferiu arma√ß√£o preta"
}
```

**Response 201:**
```json
{
  "id": 1,
  "order_number": "OS-2024-001",
  "customer_id": 5,
  "store_id": 2,
  "seller_id": 3,
  "status": "DRAFT",
  "subtotal": "0.00",
  "discount_amount": "0.00",
  "discount_percentage": null,
  "total": "0.00",
  "created_at": "2024-12-15T10:30:00Z",
  "items": []
}
```

**Regras de Neg√≥cio:**
- `seller_id` √© automaticamente o ID do usu√°rio logado
- `order_number` √© gerado automaticamente (formato: `OS-{YYYY}-{NNNN}`)
- `status` sempre inicia como `DRAFT`
- `store_id` deve ser validado (usu√°rio deve ter acesso √† loja)
- `customer_id` deve existir e estar ativo

**Erros:**
- `400` - Dados inv√°lidos
- `404` - Cliente ou loja n√£o encontrados
- `403` - Sem permiss√£o para a loja

---

### 4. Atualizar Service Order

**PATCH** `/api/v1/service-orders/{id}`

Atualiza dados b√°sicos da Service Order. **S√≥ pode ser editada enquanto status = DRAFT.**

**Request Body:**
```json
{
  "customer_id": 5,
  "notes": "Atualiza√ß√£o nas observa√ß√µes"
}
```

**Response 200:**
```json
{
  "id": 1,
  "order_number": "OS-2024-001",
  "customer_id": 5,
  "notes": "Atualiza√ß√£o nas observa√ß√µes",
  "status": "DRAFT",
  ...
}
```

**Regras de Neg√≥cio:**
- S√≥ pode editar se `status = "DRAFT"`
- Seller s√≥ pode editar suas pr√≥prias OS
- N√£o pode alterar `store_id`, `seller_id` ou `order_number`

**Erros:**
- `400` - Tentativa de editar OS que n√£o est√° em DRAFT
- `403` - Sem permiss√£o para editar esta OS
- `404` - OS n√£o encontrada

---

### 5. Adicionar Item √† Service Order

**POST** `/api/v1/service-orders/{id}/items`

Adiciona um item (Arma√ß√£o ou Lente) √† Service Order.

**Request Body - Arma√ß√£o:**
```json
{
  "item_type": "FRAME",
  "product_frame_id": 10,
  "quantity": 1,
  "unit_price": "450.00"
}
```

**Request Body - Lente de Estoque:**
```json
{
  "item_type": "LENS",
  "product_lens_id": 15,
  "quantity": 1,
  "unit_price": "400.00",
  "lens_spherical": -2.50,
  "lens_cylindrical": -0.75,
  "lens_axis": 180,
  "lens_addition": null,
  "lens_side": "BOTH"
}
```

**Request Body - Lente Surfa√ßagem:**
```json
{
  "item_type": "LENS",
  "product_lens_id": 20,
  "quantity": 1,
  "unit_price": "600.00",
  "lens_spherical": -3.00,
  "lens_cylindrical": -1.00,
  "lens_axis": 90,
  "lens_addition": 2.50,
  "lens_side": "BOTH"
}
```

**Response 201:**
```json
{
  "id": 1,
  "item_type": "FRAME",
  "product_frame_id": 10,
  "product_name": "Arma√ß√£o Ray-Ban RB3025",
  "quantity": 1,
  "unit_price": "450.00",
  "discount_amount": "0.00",
  "total_price": "450.00",
  "reserved_quantity": 1,
  "reserved_at": "2024-12-15T10:30:00Z"
}
```

**Regras de Neg√≥cio:**

1. **Arma√ß√£o:**
   - Valida se produto existe e est√° ativo
   - Verifica estoque dispon√≠vel (`quantity - reserved_quantity >= requested_quantity`)
   - Reserva estoque automaticamente (`reserved_quantity++` na `inventory_levels`)
   - `reserved_at` = agora
   - Se n√£o houver estoque suficiente ‚Üí `400` com mensagem

2. **Lente de Estoque (`is_lab_order = false`):**
   - Valida se produto existe e est√° ativo
   - Verifica saldo na `lens_stock_grid` com os par√¢metros fornecidos (spherical, cylindrical, axis)
   - Se n√£o houver saldo ‚Üí `400` com mensagem ou marca `needs_purchasing = true`
   - Campos obrigat√≥rios: `lens_spherical`, `lens_cylindrical`, `lens_axis`, `lens_side`

3. **Lente Surfa√ßagem (`is_lab_order = true`):**
   - Valida se produto existe e est√° ativo
   - Sempre marca `needs_purchasing = true`
   - N√£o valida estoque

4. **Rec√°lculo:**
   - Ap√≥s adicionar item, recalcula `subtotal` e `total` da OS
   - Se houver desconto aplicado, mant√©m e recalcula

**Erros:**
- `400` - Item inv√°lido, sem estoque, ou OS n√£o est√° em DRAFT
- `403` - Sem permiss√£o
- `404` - OS ou produto n√£o encontrado

---

### 6. Remover Item da Service Order

**DELETE** `/api/v1/service-orders/{id}/items/{item_id}`

Remove um item da Service Order e libera a reserva de estoque.

**Response 204:** No Content

**Regras de Neg√≥cio:**
- S√≥ pode remover se OS est√° em `DRAFT`
- Se item era Arma√ß√£o reservada ‚Üí libera reserva (`reserved_quantity--`)
- Recalcula `subtotal` e `total` da OS
- Se houver desconto aplicado, recalcula mantendo a porcentagem

**Erros:**
- `400` - OS n√£o est√° em DRAFT
- `403` - Sem permiss√£o
- `404` - OS ou item n√£o encontrado

---

### 7. Atualizar Item da Service Order

**PATCH** `/api/v1/service-orders/{id}/items/{item_id}`

Atualiza um item existente (ex: quantidade, pre√ßo, par√¢metros da lente).

**Request Body:**
```json
{
  "quantity": 2,
  "unit_price": "420.00",
  "discount_amount": "20.00"
}
```

**Response 200:**
```json
{
  "id": 1,
  "item_type": "FRAME",
  "quantity": 2,
  "unit_price": "420.00",
  "discount_amount": "20.00",
  "total_price": "820.00",
  ...
}
```

**Regras de Neg√≥cio:**
- S√≥ pode atualizar se OS est√° em `DRAFT`
- Se alterar quantidade de Arma√ß√£o ‚Üí valida estoque dispon√≠vel
- Recalcula `total_price = (unit_price * quantity) - discount_amount`
- Recalcula `subtotal` e `total` da OS

**Erros:**
- `400` - Dados inv√°lidos ou OS n√£o est√° em DRAFT
- `403` - Sem permiss√£o
- `404` - OS ou item n√£o encontrado

---

### 8. Aplicar Desconto √† Service Order

**POST** `/api/v1/service-orders/{id}/discount`

Aplica desconto na Service Order. Se o desconto exceder o limite permitido, requer aprova√ß√£o de Manager.

**Request Body:**
```json
{
  "discount_amount": 100.00,
  "discount_percentage": 11.76
}
```

**OU:**

```json
{
  "discount_percentage": 15.0
}
```

**Response 200:**
```json
{
  "id": 1,
  "discount_amount": "100.00",
  "discount_percentage": "11.76",
  "total": "750.00",
  "max_discount_allowed": "100.00",
  "discount_approved_by": 2,
  "status": "DRAFT"
}
```

**Regras de Neg√≥cio:**

1. **C√°lculo:**
   - Se enviar `discount_amount` ‚Üí calcula `discount_percentage = (discount_amount / subtotal) * 100`
   - Se enviar `discount_percentage` ‚Üí calcula `discount_amount = (subtotal * discount_percentage) / 100`

2. **Valida√ß√£o de Limite:**
   - Cada Seller tem um `max_discount_allowed` (definido no perfil ou configura√ß√£o)
   - Se `discount_amount > max_discount_allowed`:
     - Seller: Retorna erro `403` com mensagem "Desconto excede limite permitido. Requer aprova√ß√£o de gerente."
     - Manager/Admin: Aprova automaticamente e salva `discount_approved_by = user_id`

3. **Rec√°lculo:**
   - `total = subtotal - discount_amount`
   - Mant√©m `discount_amount` e `discount_percentage`

**Erros:**
- `400` - Desconto maior que subtotal ou OS n√£o est√° em DRAFT
- `403` - Desconto excede limite e usu√°rio n√£o √© Manager
- `404` - OS n√£o encontrada

---

### 9. Enviar Service Order para Pagamento

**POST** `/api/v1/service-orders/{id}/send-to-payment`

Altera o status de `DRAFT` para `PENDING`, indicando que a OS est√° pronta para pagamento.

**Response 200:**
```json
{
  "id": 1,
  "status": "PENDING",
  "updated_at": "2024-12-15T11:00:00Z"
}
```

**Regras de Neg√≥cio:**
- Valida que OS est√° em `DRAFT`
- Valida que OS tem pelo menos 1 item
- Valida que `total > 0`
- Altera status para `PENDING`
- Reservas de estoque permanecem ativas (ser√£o convertidas em baixa no checkout)

**Erros:**
- `400` - OS n√£o est√° em DRAFT, sem itens, ou total = 0
- `403` - Sem permiss√£o
- `404` - OS n√£o encontrada

---

### 10. Cancelar Service Order

**POST** `/api/v1/service-orders/{id}/cancel`

Cancela uma Service Order. Libera todas as reservas de estoque.

**Request Body (opcional):**
```json
{
  "reason": "Cliente desistiu da compra"
}
```

**Response 200:**
```json
{
  "id": 1,
  "status": "CANCELLED",
  "updated_at": "2024-12-15T11:30:00Z"
}
```

**Regras de Neg√≥cio:**
- S√≥ pode cancelar se status √© `DRAFT` ou `PENDING`
- Se status = `DRAFT` ou `PENDING` ‚Üí libera todas as reservas de estoque
- Altera status para `CANCELLED`
- Manager/Admin podem cancelar qualquer OS
- Seller s√≥ pode cancelar suas pr√≥prias OS

**Erros:**
- `400` - OS j√° est√° paga ou entregue
- `403` - Sem permiss√£o
- `404` - OS n√£o encontrada

---

## üîß Regras de Neg√≥cio Importantes

### Reserva de Estoque

1. **Arma√ß√£o:**
   - Ao adicionar ‚Üí Incrementa `reserved_quantity` na `inventory_levels`
   - Ao remover ‚Üí Decrementa `reserved_quantity`
   - Ao cancelar ‚Üí Libera todas as reservas
   - No checkout ‚Üí Converte reserva em baixa real (`quantity--`, `reserved_quantity--`)

2. **Lente de Estoque:**
   - N√£o reserva automaticamente (valida apenas saldo dispon√≠vel)
   - Reserva ser√° feita no checkout

### Expira√ß√£o de Reservas

**Nota para backend:** Implementar job/cron que:
- Libera reservas de OS em `DRAFT` que est√£o inativas h√° 24h
- Notifica o Seller sobre a libera√ß√£o

### Valida√ß√£o de Descontos

- `max_discount_allowed` pode vir de:
  1. Configura√ß√£o global da organiza√ß√£o
  2. Configura√ß√£o por loja
  3. Configura√ß√£o por Seller
- Prioridade: Seller > Loja > Global

---

## üìä Status da Service Order

```typescript
enum ServiceOrderStatus {
  DRAFT = "DRAFT",              // Rascunho - pode editar
  PENDING = "PENDING",          // Aguardando pagamento
  PAID = "PAID",                // Paga - vai para produ√ß√£o
  AWAITING_LENS = "AWAITING_LENS",  // Aguardando lente (surfa√ßagem)
  IN_PRODUCTION = "IN_PRODUCTION",  // Em montagem
  READY = "READY",              // Pronta para entrega
  DELIVERED = "DELIVERED",      // Entregue
  CANCELLED = "CANCELLED"       // Cancelada
}
```

---

## üóÇÔ∏è Estrutura de Dados - service_order_items

**Campos importantes:**

- `item_type`: "FRAME" | "LENS"
- `reserved_quantity`: Quantidade reservada (s√≥ para Arma√ß√£o)
- `needs_purchasing`: true se lente precisa ser comprada (surfa√ßagem)
- `lens_*`: Par√¢metros da lente (spherical, cylindrical, axis, addition, side)

---

## ‚úÖ Checklist de Implementa√ß√£o Backend

- [ ] Router `/api/v1/service-orders`
- [ ] Endpoint GET `/` - Listar OS
- [ ] Endpoint GET `/{id}` - Detalhes da OS
- [ ] Endpoint POST `/` - Criar OS
- [ ] Endpoint PATCH `/{id}` - Atualizar OS
- [ ] Endpoint POST `/{id}/items` - Adicionar item
- [ ] Endpoint DELETE `/{id}/items/{item_id}` - Remover item
- [ ] Endpoint PATCH `/{id}/items/{item_id}` - Atualizar item
- [ ] Endpoint POST `/{id}/discount` - Aplicar desconto
- [ ] Endpoint POST `/{id}/send-to-payment` - Enviar para pagamento
- [ ] Endpoint POST `/{id}/cancel` - Cancelar OS
- [ ] L√≥gica de reserva de estoque
- [ ] Valida√ß√£o de desconto e limites
- [ ] Valida√ß√£o de estoque de lentes
- [ ] RBAC (permiss√µes por role)
- [ ] Multi-tenancy (filtro por organization_id)

---

**Criado em:** Dezembro 2024  
**Vers√£o:** 1.0  
**Status:** Aguardando implementa√ß√£o no backend
